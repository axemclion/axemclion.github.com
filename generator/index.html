<html>
    <head>
        Web Site Generator
    </head>
    <body>
        <a href = "javascript:Generator.getFile()">Get Files</a>
    </body>
    <script type = "text/javascript" src = "http://code.jquery.com/jquery-1.4.2.min.js">
    </script>
    <script type = "text/javascript" src="libs/jquery.tmpl.js">
    </script>
    <script type = "text/javascript" src="libs/jszip.js">
    </script>
    <script type = "text/javascript">
        var Generator = (function(){
            var zip = new JSZip();
            var tasks = (function(){
                var taskDiv = $("<div>").appendTo("body");
                var tasksLeft = 0;
                return {
                    "add": function(count){
                        tasksLeft += (count || 1);
                        taskDiv.html(tasksLeft);
                    },
                    "done": function(count){
                        tasksLeft -= (count || 1);
                        taskDiv.html(tasksLeft);
                    }
                }
            })();
            
            var ajaxAll = function(urlList, allCallBack, options){
                var loaded = 0;
                var result = {};
                if (urlList.length === 0) {
                    allCallBack(result);
                    return;
                }
                options = options || {};
                var userCallbacks = {
                    "success": options.success,
                    "complete": options.complete
                }
                var ajaxOne = function(){
                    $.extend(options, {
                        "url": urlList[loaded],
                        "complete": function(data, status, xhr){
                            (typeof userCallbacks.complete === "function") && userCallbacks.complete(data, status, xhr);
                            if (loaded >= urlList.length && typeof allCallBack === "function") {
                                allCallBack.call(this, result);
                            }
                            else {
                                ajaxOne();
                            }
                        },
                        "success": function(data, status, xhr){
                            result[urlList[loaded++]] = data;
                            (typeof userCallbacks.success === "function") && userCallbacks.success(data, status, xhr);
                        }
                    });
                    $.ajax(options);
                }
                ajaxOne();
            };
            
            var templates = {};
            var loadTemplates = function(urls, callback){
                var list = [];
                for (var i = 0; i < urls.length; i++) {
                    if (typeof templates["templates/" + urls[i] + ".html"] === "undefined") {
                        list.push("templates/" + urls[i] + ".html");
                        tasks.add();
                    }
                }
                ajaxAll(list, function(data){
                    for (x in data) {
                        tasks.done();
                        templates[x] = data[x];
                    }
                    (typeof callback === "function") && callback();
                });
            };
            
            var getData = function(urlList, callback){
                var result = {};
                tasks.add(urlList.length);
                ajaxAll(urlList, function(result){
                    for (x in result) {
                        tasks.done();
                    }
                    callback(result);
                }, {
                    "dataType": "jsonp"
                });
            };
            
            var getTemplate = function(urls, callback){
                loadTemplates(urls, function(){
                    var result = [];
                    for (var i = 0; i < urls.length; i++) {
                        result.push(templates["templates/" + urls[i] + ".html"]);
                    }
                    callback.call(this, result.join(""));
                });
            };
            return {
                "loadTemplates": loadTemplates,
                "getData": getData,
                "addPage": function(templateList, data, page){
                    tasks.add();
                    getTemplate(templateList, function(template){
                        tasks.done();
                        try {
                            var content = $("<div>").append($.tmpl(template, data)).html()
                            zip.add(page, content);
                        } 
                        catch (e) {
                            console.error(e);
                        }
                    });
                },
                "getFile": function(){
                    location.href = "data:application/zip;base64," + zip.generate();
                },
            }
        })();
        
        Generator.loadTemplates(["header", "project", "projectList", "footer"], function(data){
            var base = "https://spreadsheets.google.com/feeds/list/0AjGNl56NSoledHphUkM5ZV9zdnlBYjRRanl2cGxwOGc/"
            var pages = {
                "projects": base + "od6" + "/public/values?alt=json-in-script&callback=?",
                "links": base + "od5" + "/public/values?alt=json-in-script&callback=?",
                "meta": base + "od7" + "/public/values?alt=json-in-script&callback=?",
                "misc": base + "od4" + "/public/values?alt=json-in-script&callback=?"
            }
            Generator.getData([pages.projects, pages.links, pages.meta, pages.misc], function(results){
                // Project Pages
                for (var i = 0; i < results[pages.projects].feed.entry.length; i++) {
                    Generator.addPage(["header", "project", "footer"], results[pages.projects].feed.entry[i], "projects/" + results[pages.projects].feed.entry[i].gsx$name.$t + ".html");
                }
                Generator.addPage(["header", "projectList", "footer"], results[pages.projects].feed.entry, "projects.html");
            });
        });
    </script>
</html>
