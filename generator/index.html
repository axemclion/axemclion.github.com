<html>
    <head>
        Web Site Generator
    </head>
    <body>
        <a href = "javascript:Generator.getFile()">Get Files</a>
    </body>
    <script type = "text/javascript" src = "http://code.jquery.com/jquery-1.4.2.min.js">
    </script>
    <script type = "text/javascript" src="libs/jquery.tmpl.js">
    </script>
    <script type = "text/javascript" src="libs/jszip.js">
    </script>
    <script type = "text/javascript">
        var Generator = (function(){
            var zip = new JSZip();
            var tasks = (function(){
                var taskDiv = $("<div>").appendTo("body");
                var tasksLeft = 0;
                return {
                    "add": function(count){
                        tasksLeft += (count | 1);
                        taskDiv.html(tasksLeft);
                    },
                    "done": function(count){
                        tasksLeft -= (count | 1);
                        taskDiv.html(tasksLeft);
                    }
                }
            })();
            var templates = {};
            var getTemplate = function(templateName, callback){
                if (typeof templates[templateName] !== "undefined") {
                    callback.call(this);
                    return;
                }
                var ajaxSuccess = function(key){
                    return function(data, status, xhr){
                        templates[key] = data;
                    }
                };
                $.ajax({
                    "url": ["templates/", templateName, ".html"].join(""),
                    "success": ajaxSuccess(templateName),
                    "complete": callback
                });
            }
            /**
             * Gets a list of templates in order
             * @param {Object} templateUrlList
             * @param {Object} onGetTemplates
             */
            var getTemplates = function(templateUrlList, onGetTemplates){
                var loaded = 0;
                tasks.add(templateUrlList.length);
                var gotTemplate = function(){
                    loaded++;
                    tasks.done();
                    var result = [];
                    if (loaded >= templateUrlList.length) {
                        for (var i = 0; i < templateUrlList.length; i++) {
                            result.push(templates[templateUrlList[i]]);
                        }
                        onGetTemplates.call(this, result.join(""));
                    }
                    else {
                        getTemplate(templateUrlList[loaded], gotTemplate);
                    }
                };
                getTemplate(templateUrlList[loaded], gotTemplate);
            }
            
            return {
                "getTemplates": getTemplates,
                "addPage": function(templateList, data, page){
                    tasks.add();
                    getTemplates(templateList, function(template){
                        tasks.done();
                        try {
                            var content = $("<div>").append($.tmpl(template, data)).html()
                            zip.add(page, content);
                        } 
                        catch (e) {
                        }
                    });
                },
                "getFile": function(){
                    location.href = "data:application/zip;base64," + zip.generate();
                }
            }
        })();
        
        Generator.getTemplates(["header", "project", "projectList", "footer"], function(){
            var projectsUrl = "https://spreadsheets.google.com/feeds/list/0AjGNl56NSoledHphUkM5ZV9zdnlBYjRRanl2cGxwOGc/od6/public/values?alt=json-in-script&callback=?";
            
            // Generate project pages
            $.getJSON(projectsUrl, function(data){
                var container = $("<div>");
                for (var i = 0; i < data.feed.entry.length; i++) {
                    Generator.addPage(["header", "project", "footer"], data.feed.entry[i], "projects/" + data.feed.entry[i].gsx$name.$t + ".html");
                }
                Generator.addPage(["header", "projectList", "footer"], data.feed, "projects.html");
            });
        });
    </script>
</html>
